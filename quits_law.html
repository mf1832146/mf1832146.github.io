<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>题目作答系统（多题库+错题筛选）</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Microsoft YaHei", sans-serif;
    }
    body {
      background-color: #f5f5f5;
      display: flex;
      min-height: 100vh;
      padding: 1rem;
    }

    /* 控制区域样式 */
    .controls-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
      align-items: center;
    }

    /* 密码输入区域 */
    .password-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .password-input {
      padding: 0.5rem 1rem;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
      font-size: 0.95rem;
    }
    .decrypt-btn {
      padding: 0.5rem 1.2rem;
      background-color: #6b46c1;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background-color 0.3s;
    }
    .decrypt-btn:hover {
      background-color: #553c9a;
    }

    /* 题库选择样式 */
    .question-bank-selector {
      padding: 0.5rem 1rem;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
      font-size: 0.95rem;
      background-color: white;
      cursor: pointer;
    }

    /* 错题筛选按钮 */
    .show-wrong-btn {
      padding: 0.5rem 1.2rem;
      background-color: #e53e3e;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background-color 0.3s;
    }
    .show-wrong-btn.active {
      background-color: #c53030;
      box-shadow: 0 0 0 2px rgba(229, 62, 62, 0.2);
    }
    .show-wrong-btn:hover {
      background-color: #c53030;
    }

    /* 搜索框样式 */
    .search-container {
      margin-bottom: 1.5rem;
      display: flex;
      gap: 0.5rem;
    }
    .search-input {
      flex: 1;
      padding: 0.5rem 1rem;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
      font-size: 0.95rem;
    }
    .search-btn {
      padding: 0.5rem 1.2rem;
      background-color: #48bb78;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background-color 0.3s;
    }
    .search-btn:hover {
      background-color: #38a169;
    }
    .reset-search-btn {
      padding: 0.5rem 1.2rem;
      background-color: #e2e8f0;
      color: #4a5568;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background-color 0.3s;
    }
    .reset-search-btn:hover {
      background-color: #cbd5e0;
    }
    .search-results-info {
      margin-bottom: 1rem;
      color: #4a5568;
      font-size: 0.95rem;
    }
    .search-highlight {
      background-color: #fff380;
      font-weight: bold;
    }

    /* 左侧题目主区域 */
    .main-content {
      flex: 1;
      padding: 1rem 2rem;
      overflow-y: auto;
      position: relative;
    }

    /* 打乱顺序按钮样式 */
    .shuffle-btn {
      padding: 0.5rem 1.2rem;
      background-color: #ed8936;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background-color 0.3s;
      margin-bottom: 1.5rem;
    }
    .shuffle-btn:hover {
      background-color: #dd6b20;
    }

    /* 主内容区域 */
    .main-content {
      flex: 1;
      margin-right: 1rem;
      background-color: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }


    /* 翻页控件样式 */
    .pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 1.5rem;
      gap: 1rem;
    }
    .page-btn {
      padding: 0.5rem 1.2rem;
      background-color: #4299e1;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background-color 0.3s;
    }
    .page-btn:disabled {
      background-color: #cbd5e0;
      cursor: not-allowed;
      opacity: 0.7;
    }
    .page-btn:hover:not(:disabled) {
      background-color: #3182ce;
    }
    .page-info {
      font-size: 1rem;
      color: #4a5568;
    }

    /* 题型标题（当前激活的题型） */
    .type-title {
      font-size: 1.8rem;
      color: #2d3748;
      margin-bottom: 1.5rem;
      padding-bottom: 0.8rem;
      border-bottom: 3px solid #4299e1;
      text-align: center;
    }

    /* 题目样式 */
    .question-container {
      background: white;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      display: none; /* 默认隐藏所有题目 */
    }
    .question-container.active {
      display: block; /* 当前题型+当前页的题目显示 */
    }
    .question-container.search-result {
      display: block; /* 搜索结果中的题目显示 */
    }
    .question-header {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #2d3748;
    }
    .option-group {
      margin: 1.2rem 0;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }
    .option {
      cursor: pointer;
      font-size: 1rem;
      color: #4a5568;
      display: flex;
      align-items: center;
    }
    .option input {
      margin-right: 0.8rem;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .no-options {
      color: #718096;
      font-size: 1rem;
      padding: 0.8rem;
      background-color: #f8f8f8;
      border-radius: 4px;
    }
    .btn-check {
      padding: 0.5rem 1.2rem;
      background-color: #4299e1;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background-color 0.3s;
    }
    .btn-check:hover {
      background-color: #3182ce;
    }
    .result {
      margin: 1rem 0;
      padding: 0.8rem;
      border-radius: 4px;
      font-weight: 500;
      display: none;
    }
    .correct {
      background-color: #e8f4f8;
      color: #22543d;
      border: 1px solid #c3e6cb;
    }
    .incorrect {
      background-color: #fdf2f8;
      color: #742a2a;
      border: 1px solid #f5c6c6;
    }
    .explanation {
      margin-top: 1rem;
      padding: 1rem;
      background-color: #f8f8f8;
      border-left: 3px solid #9f7aea;
      color: #2d3748;
      display: none;
      line-height: 1.6;
    }

    /* 右侧导航栏：纵向分组（判断题→单选题→多选题） */
    .sidebar {
      width: 200px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      padding: 1.2rem;
      margin-left: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      position: sticky;
      top: 1rem;
      height: fit-content;
    }
    /* 每个题型的导航分组 */
    .nav-group {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }
    /* 题型导航标题 */
    .nav-group-title {
      font-size: 1rem;
      font-weight: 600;
      color: #2d3748;
      padding-bottom: 0.4rem;
      border-bottom: 2px solid #f3f4f6;
    }
    /* 题目序号容器（横向换行） */
    .nav-items-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
    }
    /* 题目序号 */
    .nav-item {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f5f5f5;
      color: #4a5568;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .nav-item:hover {
      transform: scale(1.05);
    }
    /* 当前激活的题型下，当前页的序号高亮 */
    .nav-item.active {
      border: 2px solid #4299e1;
    }
    .nav-item.correct {
      background-color: #48bb78;
      color: white;
    }
    .nav-item.incorrect {
      background-color: #dc2626;
      color: white;
    }

    /* 加载和错误提示 */
    .loading, .error {
      text-align: center;
      font-size: 1.2rem;
      color: #4a5568;
      padding: 2rem;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      white-space: pre-line;
    }
    .error {
      color: #dc2626;
    }

    /* 响应式适配（手机端：导航栏在上，题目在下） */
    @media (max-width: 768px) {
      body {
        flex-direction: column;
        padding: 0.5rem;
      }
      .sidebar {
        width: 100%;
        margin: 0.5rem 0;
        flex-direction: row;
        overflow-x: auto;
        padding: 0.8rem;
        gap: 1rem;
      }
      .nav-group {
        min-width: 150px;
      }
      .main-content {
        padding: 0.5rem;
      }
      .pagination {
        gap: 0.5rem;
      }
      .page-btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
      }
      .search-container, .controls-container {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- 左侧题目区域 -->
  <div class="main-content">
    <!-- 题型标题（当前激活的题型） -->
    <h2 class="type-title" id="current-type-title">判断题</h2>

    <!-- 控制区域：题库选择 + 错题筛选 -->
    <div class="controls-container">
        <div class="password-container">
        <input type="password" class="password-input" id="password-input" placeholder="输入解密密码">
        <button class="decrypt-btn" id="decrypt-btn">输入密码</button>
      </div>
      <select class="question-bank-selector" id="question-bank-selector">
            <option value="bank0">0.武器使用理论题</option>
            <option value="bank1">1.社会主义法治理念</option>
            <option value="bank2">2.法律基本概念</option>
            <option value="bank3">3.宪法</option>
            <option value="bank4">4.人民警察法</option>
            <option value="bank5">5.反恐怖主义法</option>
            <option value="bank6">6.公安机关组织管理条例</option>
            <option value="bank7">7.人民警察使用武器和警械条例</option>
            <option value="bank8">8.治安管理处罚法（不含程序部分）基本级2改</option>
            <option value="bank9">9.办理行政案件程序</option>
            <option value="bank10">10.基本级刑法</option>
            <option value="bank11">11.办理刑事案件程序</option>
          <option value="all" style="font-weight: bold; color: #6b46c1;">全科目汇总</option>
      </select>

    </div>

    <!-- 搜索区域 -->
    <div class="search-container">
      <input type="text" class="search-input" id="search-input" placeholder="输入关键词搜索题目...">
      <button class="search-btn" id="search-btn">搜索</button>
      <button class="reset-search-btn" id="reset-search-btn" style="display: none;">返回原题</button>
    </div>
    <div class="search-results-info" id="search-results-info" style="display: none;"></div>

    <!-- 打乱顺序按钮 -->
    <button class="shuffle-btn" id="shuffle-btn">打乱题目和选项的顺序</button>
      <button class="show-wrong-btn" id="show-wrong-btn">显示收藏和错题</button>
      <button id="toggleExplainBtn" onclick="showAllQuestions()" class="show-wrong-btn">查看解析</button>
    <div class="loading" id="loading">题库已加密，请输入密码，解压题库...</div>
    <div class="error" id="error" style="display: none;"></div>
    <div id="question-list"></div>

    <!-- 翻页控件 -->
    <div class="pagination" id="pagination" style="display: none;">
      <button class="page-btn" id="prev-page" disabled>上一页</button>
      <span class="page-info" id="page-info">第 1 页 / 共 0 页</span>
      <button class="page-btn" id="next-page" disabled>下一页</button>
    </div>
  </div>

  <!-- 右侧导航栏：纵向分组（判断题→单选题→多选题） -->
  <div class="sidebar">
    <!-- 判断题导航分组 -->
    <div class="nav-group" data-type="judgment">
      <div class="nav-group-title">判断题</div>
      <div class="nav-items-container" id="judgment-nav-items"></div>
    </div>
    <!-- 单选题导航分组 -->
    <div class="nav-group" data-type="single">
      <div class="nav-group-title">单选题</div>
      <div class="nav-items-container" id="single-nav-items"></div>
    </div>
    <!-- 多选题导航分组 -->
    <div class="nav-group" data-type="multiple">
      <div class="nav-group-title">多选题</div>
      <div class="nav-items-container" id="multiple-nav-items"></div>
    </div>
  </div>

  <script>
    // 题库配置 - 每个题库对应一个JSON文件
    const BANK_CONFIG = {
        bank0: {
            name: "武器使用理论题",
            path: "https://zetang94.github.io/assets/quits/law/0.武器使用理论题.txt"
        },
        bank1: {
            name: "社会主义法治理念",
            path: "https://zetang94.github.io/assets/quits/law/1.社会主义法治理念.txt"
        },
        bank2: {
            name: "法律基本概念",
            path: "https://zetang94.github.io/assets/quits/law/2.法律基本概念.txt"
        },
        bank3: {
            name: "宪法",
            path: "https://zetang94.github.io/assets/quits/law/3.宪法.txt"
        },
        bank4: {
            name: "人民警察法",
            path: "https://zetang94.github.io/assets/quits/law/4.人民警察法.txt"
        },
        bank5: {
            name: "反恐怖主义法",
            path: "https://zetang94.github.io/assets/quits/law/5.反恐怖主义法.txt"
        },
        bank6: {
            name: "公安机关组织管理条例",
            path: "https://zetang94.github.io/assets/quits/law/6.公安机关组织管理条例.txt"
        },
        bank7: {
            name: "人民警察使用武器和警械条例",
            path: "https://zetang94.github.io/assets/quits/law/7.人民警察使用武器和警械条例.txt"
        },
        bank8: {
            name: "治安管理处罚法（不含程序部分）基本级2改",
            path: "https://zetang94.github.io/assets/quits/law/8.治安管理处罚法（不含程序部分）基本级2改.txt"
        },
        bank9: {
            name: "办理行政案件程序",
            path: "https://zetang94.github.io/assets/quits/law/9.办理行政案件程序.txt"
        },
        bank10: {
            name: "基本级刑法",
            path: "https://zetang94.github.io/assets/quits/law/10.基本级刑法.txt"
        },
        bank11: {
            name: "办理刑事案件程序",
            path: "https://zetang94.github.io/assets/quits/law/11.办理刑事案件程序.txt"
        }
    };

    // 题型映射
    const TYPE_MAPPING = {
      "判断题": "judgment",
      "单选题": "single",
      "多选题": "multiple"
    };

    // 按题库和题型分类存储题目
    let questionData = {};
    // 保存原始题目顺序，用于重置打乱状态
    let originalQuestionData = {};
    // 作答状态：key=题库-题型-题目ID，避免同ID冲突
    let answerStatus = {};
    let favoriteStatus = {};
    const PASSWORD_CACHE_KEY = "quiz_pwd_cache";
    const BANK_CACHE_KEY = "quiz_last_bank";
    let GET_EXLPAIN = false;
    // 翻页相关变量
    let pageState = {
      currentBank: "bank1",      // 当前激活的题库
      currentType: "judgment",   // 当前激活的题型
      currentPage: 1,            // 当前页码
      pageSize: 5,               // 每页显示题目数
      totalPages: {},            // 各题型总页数（key=题型key）
      searchMode: false,         // 是否处于搜索模式
      searchResults: [],         // 搜索结果
      searchKeyword: "",         // 当前搜索关键词
      showWrongOnly: false,      // 是否只显示错题
        decrypted: false           // 是否已解密
    };

    // window.onbeforeunload = () => {
    //   localStorage.setItem("answerStatus", JSON.stringify(answerStatus));
    //   localStorage.setItem("favoriteStatus", JSON.stringify(favoriteStatus));
    //   localStorage.setItem("password", "");
    // };

    // 页面加载完成后初始化
    window.onload = async function() {
      try {
      answerStatus = JSON.parse(localStorage.getItem("answerStatus") || "{}");
      favoriteStatus = JSON.parse(localStorage.getItem("favoriteStatus") || "{}");
      const cachedBank = localStorage.getItem(BANK_CACHE_KEY);
        if (cachedBank && BANK_CONFIG[cachedBank]) {
          pageState.currentBank = cachedBank;
        }
         document.getElementById("question-bank-selector").value = pageState.currentBank;
        // 初始化所有题库容器
        Object.keys(BANK_CONFIG).forEach(bankKey => {
          questionData[bankKey] = {
            judgment: [],
            single: [],
            multiple: []
          };
          originalQuestionData[bankKey] = {
            judgment: [],
            single: [],
            multiple: []
          };
        });

        // 加载当前选中的题库
        //await loadQuestionBank(pageState.currentBank);

        // 初始化作答状态（所有题目默认未作答）
        // initAnswerStatus();
        //
        // // 渲染导航栏、题目、翻页控件
        // renderAllNavItems();
        // renderQuestions();
        // renderPagination();
        bindEvents();

        const cachedPwd = localStorage.getItem(PASSWORD_CACHE_KEY);
        if (cachedPwd) {
          document.getElementById("password-input").value = cachedPwd;
          document.getElementById("decrypt-btn").click();
        }


        // 显示内容，隐藏加载提示
        //document.getElementById("loading").style.display = "none";
        //document.getElementById("pagination").style.display = "flex";
        document.getElementById("question-bank-selector").style.display = "none";
        document.getElementById("question-list").style.display = "block";
      } catch (error) {
        document.getElementById("loading").style.display = "none";
        const errorEl = document.getElementById("error");
        errorEl.style.display = "flex";
        errorEl.textContent = `❌ 加载失败：${error.message}\n请确保JSON网址可访问、支持跨域（CORS），并使用HTTPS协议`;
      }
    };

    /**
     * 绑定所有事件
     */
    function bindEvents() {
      // 解密按钮点击事件
      document.getElementById('decrypt-btn').addEventListener('click', async () => {
        const password = document.getElementById('password-input').value;
        const currentBank = document.getElementById('question-bank-selector').value;

        try {
          document.getElementById("loading").textContent = "加载题目中..."
          document.getElementById('loading').style.display = 'flex';
          document.getElementById('error').style.display = 'none';
          await loadAndDecryptBank(currentBank, password);
          initAnswerStatus();
          renderAllNavItems();
          renderQuestions();
          renderPagination();
          document.getElementById("question-bank-selector").style.display = 'flex';
          document.getElementById('pagination').style.display = 'flex';
        } catch (error) {
          document.getElementById('error').style.display = 'flex';
          document.getElementById('error').textContent = error.message;
        } finally {
          document.getElementById('loading').style.display = 'none';
        }
      });

      // 上一页按钮
      document.getElementById("prev-page").addEventListener("click", () => {
        if (pageState.currentPage > 1) {
          pageState.currentPage--;
          renderQuestions();
          renderAllNavItems();
          renderPagination();
          scrollToTop();
        }
      });

      // 收藏按钮点击
    document.getElementById("question-list").addEventListener("click", (e) => {
      if (e.target.classList.contains("favorite-btn")) {
        const key = e.target.dataset.key;
        favoriteStatus[key] = !favoriteStatus[key];
        e.target.textContent = favoriteStatus[key] ? "⭐" : "☆";
        saveLocalState();
      }
    });

      // 下一页按钮
      document.getElementById("next-page").addEventListener("click", () => {
        let totalPages;
        if (pageState.searchMode) {
          totalPages = pageState.totalPages.search || 1;
        } else {
          let currentQuestions = questionData[pageState.currentBank][pageState.currentType];
          if (pageState.showWrongOnly) {
            currentQuestions = currentQuestions.filter(q => answerStatus[q.uniqueKey] === "incorrect"||
    favoriteStatus[q.uniqueKey]);
          }
          totalPages = Math.ceil(currentQuestions.length / pageState.pageSize) || 1;
        }

        if (pageState.currentPage < totalPages) {
          pageState.currentPage++;
          renderQuestions();
          renderAllNavItems();
          renderPagination();
          scrollToTop();
        }
      });

      // 打乱顺序按钮
      document.getElementById("shuffle-btn").addEventListener("click", shuffleQuestions);

      // 查看解析按钮事件委托
      document.getElementById("question-list").addEventListener("click", (e) => {
        if (e.target.classList.contains("btn-check")) {
          const uniqueKey = e.target.dataset.uniqueKey;
          checkAnswer(uniqueKey);
        }
      });

      // 搜索按钮事件
      document.getElementById("search-btn").addEventListener("click", () => {
        const keyword = document.getElementById("search-input").value;
        performSearch(keyword);
      });

      // 搜索框回车事件
      document.getElementById("search-input").addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          const keyword = document.getElementById("search-input").value;
          performSearch(keyword);
        }
      });

      // 重置搜索按钮事件
      document.getElementById("reset-search-btn").addEventListener("click", resetSearch);

      // 题库切换事件
      document.getElementById("question-bank-selector").addEventListener("change", (e) => {
          const bank = e.target.value;

            // ✅ 保存当前 bank
            localStorage.setItem(BANK_CACHE_KEY, bank);
          switchQuestionBank(e.target.value);
      });

      // 错题筛选按钮事件
      document.getElementById("show-wrong-btn").addEventListener("click", toggleWrongOnly);
    }

    /**
     * 加载并解密指定题库
     */
//     async function loadAndDecryptBank(bankKey, password) {
//     if (!password) {
//         throw new Error("请输入解密密码");
//     }
//
//     // 如果是全科目模式
//     if (bankKey === "all") {
//         const allJudgment = [];
//         const allSingle = [];
//         const allMultiple = [];
//
//         // 遍历所有真实的题库键（排除 'all' 自己）
//         const realBankKeys = Object.keys(BANK_CONFIG).filter(k => k !== 'all');
//
//         for (const key of realBankKeys) {
//             try {
//                 // 复用单库解密逻辑的核心部分，但不直接修改全局 questionData，而是先获取数据
//                 const data = await decryptSingleBank(key, password);
//                 allJudgment.push(...data.judgment);
//                 allSingle.push(...data.single);
//                 allMultiple.push(...data.multiple);
//             } catch (e) {
//                 console.error(`加载库 ${key} 失败:`, e);
//                 // 如果是密码错误，直接抛出，不再尝试后续
//                 if (e.message.includes("密码错误")) throw e;
//             }
//         }
//
//         questionData["all"] = { judgment: allJudgment, single: allSingle, multiple: allMultiple };
//         originalQuestionData["all"] = {
//             judgment: [...allJudgment],
//             single: [...allSingle],
//             multiple: [...allMultiple]
//         };
//
//         pageState.totalPages["all"] = {
//             judgment: Math.ceil(allJudgment.length / pageState.pageSize),
//             single: Math.ceil(allSingle.length / pageState.pageSize),
//             multiple: Math.ceil(allMultiple.length / pageState.pageSize)
//         };
//
//         pageState.decrypted = true;
//         pageState.currentBank = "all";
//         return;
//     }
//
//     // 正常的单库加载逻辑...
//     await decryptSingleBank(bankKey, password, true);
// }
//
// /**
//  * 提取出来的通用解密工具函数
//  */
// async function decryptSingleBank(bankKey, password, updateGlobal = false) {
//     const bankConfig = BANK_CONFIG[bankKey];
//     const response = await fetch(bankConfig.path);
//     if (!response.ok) throw new Error(`加载${bankConfig.name}失败`);
//
//     const encryptedText = await response.text();
//     const lines = encryptedText.split('\n').map(l => l.trim()).filter(l => l);
//
//     const salt = CryptoJS.enc.Base64.parse(lines[0]);
//     const iv = CryptoJS.enc.Base64.parse(lines[1]);
//     const ciphertext = CryptoJS.enc.Base64.parse(lines[2]);
//
//     const key = CryptoJS.PBKDF2(password, salt, { keySize: 8, iterations: 100000, hasher: CryptoJS.algo.SHA256 });
//     const decrypted = CryptoJS.AES.decrypt({ ciphertext: ciphertext }, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
//     const decryptedText = decrypted.toString(CryptoJS.enc.Utf8);
//
//     if (!decryptedText) throw new Error("解密失败：密码错误或文件损坏");
//
//     const questions = JSON.parse(decryptedText);
//     const result = { judgment: [], single: [], multiple: [] };
//
//     questions.forEach((q) => {
//         const typeKey = TYPE_MAPPING[q.type] || "judgment";
//         const formattedQuestion = { ...q, uniqueKey: `${bankKey}-${typeKey}-${q.id}`, typeKey, bankKey };
//         result[typeKey].push(formattedQuestion);
//     });
//
//     if (updateGlobal) {
//         questionData[bankKey] = result;
//         originalQuestionData[bankKey] = JSON.parse(JSON.stringify(result));
//         pageState.totalPages[bankKey] = {
//             judgment: Math.ceil(result.judgment.length / pageState.pageSize),
//             single: Math.ceil(result.single.length / pageState.pageSize),
//             multiple: Math.ceil(result.multiple.length / pageState.pageSize)
//         };
//         pageState.decrypted = true;
//         pageState.currentBank = bankKey;
//         localStorage.setItem(PASSWORD_CACHE_KEY, password);
//     }
//     return result;
// }
    /**
 * 修改后的核心加载函数：支持进度显示
 */
async function loadAndDecryptBank(bankKey, password) {
  if (!password) throw new Error("请输入解密密码");

  const loadingEl = document.getElementById("loading");

  // 如果是全科目模式
  if (bankKey === "all") {
    const allJudgment = [];
    const allSingle = [];
    const allMultiple = [];

    // 获取所有有效的题库键
    const realBankKeys = Object.keys(BANK_CONFIG).filter(k => k !== 'all');
    const totalBanks = realBankKeys.length;

    for (let i = 0; i < totalBanks; i++) {
      const key = realBankKeys[i];
      // 更新加载进度 UI
      loadingEl.textContent = `正在解密全科目资源... (${i + 1}/${totalBanks})\n当前：${BANK_CONFIG[key].name}`;

      try {
        const data = await decryptCore(key, password);
        allJudgment.push(...data.judgment);
        allSingle.push(...data.single);
        allMultiple.push(...data.multiple);
      } catch (e) {
        console.error(`加载 ${key} 失败:`, e);
        if (e.message.includes("密码错误")) throw e;
      }
    }

    // 整合数据
    questionData["all"] = { judgment: allJudgment, single: allSingle, multiple: allMultiple };
    originalQuestionData["all"] = JSON.parse(JSON.stringify(questionData["all"]));

    pageState.totalPages["all"] = {
      judgment: Math.ceil(allJudgment.length / pageState.pageSize),
      single: Math.ceil(allSingle.length / pageState.pageSize),
      multiple: Math.ceil(allMultiple.length / pageState.pageSize)
    };

    pageState.decrypted = true;
    pageState.currentBank = "all";
    localStorage.setItem(PASSWORD_CACHE_KEY, password);
    return;
  }

  // 单个题库加载模式
  loadingEl.textContent = "正在解密单个题库...";
  const data = await decryptCore(bankKey, password);

  // 更新全局状态
  questionData[bankKey] = data;
  originalQuestionData[bankKey] = JSON.parse(JSON.stringify(data));
  pageState.totalPages[bankKey] = {
    judgment: Math.ceil(data.judgment.length / pageState.pageSize),
    single: Math.ceil(data.single.length / pageState.pageSize),
    multiple: Math.ceil(data.multiple.length / pageState.pageSize)
  };

  pageState.decrypted = true;
  pageState.currentBank = bankKey;
  localStorage.setItem(PASSWORD_CACHE_KEY, password);
}

/**
 * 独立的解密核心逻辑
 */
async function decryptCore(bankKey, password) {
  const bankConfig = BANK_CONFIG[bankKey];
  const response = await fetch(bankConfig.path);
  if (!response.ok) throw new Error(`无法获取文件: ${bankConfig.name}`);

  const encryptedText = await response.text();
  const lines = encryptedText.split('\n').map(l => l.trim()).filter(l => l);

  const salt = CryptoJS.enc.Base64.parse(lines[0]);
  const iv = CryptoJS.enc.Base64.parse(lines[1]);
  const ciphertext = CryptoJS.enc.Base64.parse(lines[2]);

  const key = CryptoJS.PBKDF2(password, salt, {
    keySize: 8,
    iterations: 100000,
    hasher: CryptoJS.algo.SHA256
  });

  const decrypted = CryptoJS.AES.decrypt({ ciphertext: ciphertext }, key, {
    iv: iv,
    mode: CryptoJS.mode.CBC,
    padding: CryptoJS.pad.Pkcs7
  });

  const decryptedText = decrypted.toString(CryptoJS.enc.Utf8);
  if (!decryptedText) throw new Error("密码错误或数据损坏");

  const questions = JSON.parse(decryptedText);
  const result = { judgment: [], single: [], multiple: [] };

  questions.forEach(q => {
    const typeKey = TYPE_MAPPING[q.type] || "judgment";
    result[typeKey].push({
      ...q,
      uniqueKey: `${bankKey}-${typeKey}-${q.id}`, // 关键：确保全科目模式下 ID 不重复
      typeKey,
      bankKey
    });
  });

  return result;
}
    // async function loadAndDecryptBank(bankKey, password) {
    //   if (!password) {
    //     throw new Error("请输入解密密码");
    //   }
    //
    //   if (pageState.decrypted && questionData[bankKey] && questionData[bankKey].judgment.length > 0) {
    //     return;
    //   }
    //
    //   const bankConfig = BANK_CONFIG[bankKey];
    //   const response = await fetch(bankConfig.path);
    //
    //   if (!response.ok) {
    //     throw new Error(`加载${bankConfig.name}失败，状态码：${response.status}`);
    //   }
    //
    //   // 以文本形式读取加密文件
    //   const encryptedText = await response.text();
    //   const lines = encryptedText.split('\n')
    //     .map(line => line.trim())
    //     .filter(line => line);
    //
    //   // 验证文件格式
    //   if (lines.length !== 3) {
    //     throw new Error(`无效的加密文件格式：应包含3行数据，实际包含${lines.length}行`);
    //   }
    //
    //   try {
    //     // 解析Base64编码的盐值、IV和密文
    //     const salt = CryptoJS.enc.Base64.parse(lines[0]);
    //     const iv = CryptoJS.enc.Base64.parse(lines[1]);
    //     const ciphertext = CryptoJS.enc.Base64.parse(lines[2]);
    //
    //     // 使用PBKDF2从密码派生密钥
    //     const key = CryptoJS.PBKDF2(
    //       password,
    //       salt,
    //       { keySize: 8, iterations: 100000, hasher: CryptoJS.algo.SHA256 }
    //     );
    //
    //     // 解密
    //     const decrypted = CryptoJS.AES.decrypt(
    //       { ciphertext: ciphertext },
    //       key,
    //       {
    //         iv: iv,
    //         mode: CryptoJS.mode.CBC,
    //         padding: CryptoJS.pad.Pkcs7
    //       }
    //     );
    //
    //     // 验证解密结果
    //     const decryptedText = decrypted.toString(CryptoJS.enc.Utf8);
    //     if (!decryptedText) {
    //       throw new Error("解密结果为空，可能密码错误或文件损坏");
    //     }
    //
    //     // 解析JSON
    //     let questions;
    //     try {
    //       questions = JSON.parse(decryptedText);
    //     } catch (e) {
    //       throw new Error("解密结果不是有效的JSON格式：" + e.message);
    //     }
    //
    //     // 验证题目格式
    //     if (!Array.isArray(questions)) {
    //       throw new Error("解密结果不是有效的题目数组");
    //     }
    //
    //     localStorage.setItem(PASSWORD_CACHE_KEY, password);
    //
    //     // 按题型分类存储题目
    //     const judgment = [];
    //     const single = [];
    //     const multiple = [];
    //
    //     questions.forEach((q, index) => {
    //     // 根据题目中的type属性进行分类
    //     const typeKey = TYPE_MAPPING[q.type] || "judgment"; // 默认判断题
    //     const uniqueKey = `${bankKey}-${typeKey}-${q.id}`; // 唯一标识（题库-题型-ID）
    //
    //     const formattedQuestion = {
    //       ...q,
    //       uniqueKey,
    //       typeKey,
    //       bankKey
    //     };
    //
    //     switch (typeKey) {
    //       case "judgment":
    //         judgment.push(formattedQuestion);
    //         break;
    //       case "single":
    //         single.push(formattedQuestion);
    //         break;
    //       case "multiple":
    //         multiple.push(formattedQuestion);
    //         break;
    //     }
    //   });
    //
    //   // 存储题目数据
    //   questionData[bankKey] = { judgment, single, multiple };
    //   originalQuestionData[bankKey] = {
    //     judgment: [...judgment],
    //     single: [...single],
    //     multiple: [...multiple]
    //   };
    //
    //   // 初始化该题库各题型的总页数
    //   pageState.totalPages[bankKey] = {
    //     judgment: Math.ceil(judgment.length / pageState.pageSize),
    //     single: Math.ceil(single.length / pageState.pageSize),
    //     multiple: Math.ceil(multiple.length / pageState.pageSize)
    //   };
    //
    //     pageState.decrypted = true;
    //     pageState.currentBank = bankKey;
    //   } catch (e) {
    //     // 细化错误提示
    //     if (e.message.includes('Malformed UTF-8')) {
    //       throw new Error("解密失败：密码错误或文件损坏（无效的UTF-8数据）");
    //     } else if (e.message.includes('PKCS#7')) {
    //       throw new Error("解密失败：填充错误，可能是密码错误或数据损坏");
    //     } else {
    //       throw new Error("解密失败：" + e.message);
    //     }
    //   }
    // }

    /**
     * 切换题库
     */
    async function switchQuestionBank(bankKey) {
      if (bankKey === pageState.currentBank) return;

      // 显示加载状态
      document.getElementById("loading").style.display = "flex";
      document.getElementById("question-list").style.display = "none";
      document.getElementById("pagination").style.display = "none";

      try {
        // 加载新题库
        const password = document.getElementById('password-input').value;
        await loadAndDecryptBank(bankKey, password);

        // 更新状态
        pageState.currentBank = bankKey;
        pageState.currentType = "judgment"; // 切换题库后默认显示判断题
        pageState.currentPage = 1;
        pageState.searchMode = false;
        pageState.searchResults = [];
        pageState.searchKeyword = "";

        // 初始化新题库的作答状态（如果不存在）
        initAnswerStatus();

        // 更新UI
        document.getElementById("current-type-title").textContent = "判断题";
        document.getElementById("search-input").value = "";
        document.getElementById("reset-search-btn").style.display = "none";
        document.getElementById("search-results-info").style.display = "none";
        document.getElementById("shuffle-btn").style.display = "inline-block";

        // 重新渲染
        renderAllNavItems();
        renderQuestions();
        renderPagination();
      } catch (error) {
        const errorEl = document.getElementById("error");
        errorEl.style.display = "flex";
        errorEl.textContent = `❌ 切换题库失败：${error.message}`;
      } finally {
        document.getElementById("loading").style.display = "none";
        document.getElementById("question-list").style.display = "block";
        document.getElementById("pagination").style.display = "flex";
      }
    }

    /**
     * 切换错题显示模式
     */
    function toggleWrongOnly() {
      pageState.showWrongOnly = !pageState.showWrongOnly;
      pageState.currentPage = 1; // 重置到第一页

      // 更新按钮样式
      const btn = document.getElementById("show-wrong-btn");
      btn.classList.toggle("active", pageState.showWrongOnly);

      // 如果在搜索模式下，先退出搜索
      if (pageState.searchMode) {
        resetSearch();
      }

      // 重新渲染
      renderAllNavItems();
      renderQuestions();
      renderPagination();
    }

    /**
     * 初始化当前题库的作答状态
     */
    function initAnswerStatus() {
      const currentBankQuestions = Object.values(questionData[pageState.currentBank]).flat();
      currentBankQuestions.forEach(question => {
        if (!answerStatus.hasOwnProperty(question.uniqueKey)) {
          answerStatus[question.uniqueKey] = "unanswered";
        }
      });
    }

    /**
     * 打乱当前题库各题型组内的题目顺序
     */
    function shuffleQuestions() {
      const currentBank = pageState.currentBank;

      Object.keys(TYPE_MAPPING).forEach(typeName => {
        const typeKey = TYPE_MAPPING[typeName];

        // 1. 复制题目数组
        const shuffled = [...questionData[currentBank][typeKey]];

        // 2. 打乱题目顺序（Fisher–Yates）
        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }

        // 3. 打乱选项顺序
        shuffled.forEach(question => {
          if (question.selections) {
            const entries = Object.entries(question.selections); // [['A','xxx'], ['B','xxx'], ...]

            // 洗牌选项
            for (let i = entries.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [entries[i], entries[j]] = [entries[j], entries[i]];
            }

            // 重新生成 A/B/C/D 的键
            const newSelections = {};
            const optionLabels = ['A', 'B', 'C', 'D', 'E'];

            entries.forEach((entry, idx) => {
              newSelections[optionLabels[idx]] = entry[1];
            });

            // 修改答案的键
            if (question.answer) {
              const oldAnsArray = question.answer.split("");
              const newAnsArray = [];

              entries.forEach((entry, idx) => {
                const oldKey = entry[0];
                if (oldAnsArray.includes(oldKey)) {
                  newAnsArray.push(optionLabels[idx]);
                }
              });

              question.answer = newAnsArray.join("");
            }

            question.selections = newSelections;
          }
        });

        // 保存结果
        questionData[currentBank][typeKey] = shuffled;

        // 更新分页
        pageState.totalPages[currentBank][typeKey] = Math.ceil(shuffled.length / pageState.pageSize);
      });

      // 重置到第一页并刷新 UI
      pageState.currentPage = 1;
      renderAllNavItems();
      renderQuestions();
      renderPagination();
    }

    /**
     * 执行搜索功能
     */
    function performSearch(keyword) {
      if (!keyword.trim()) {
        alert("请输入搜索关键词");
        return;
      }

      keyword = keyword.trim().toLowerCase();
      pageState.searchKeyword = keyword;
      pageState.searchMode = true;
      pageState.currentPage = 1; // 重置到第一页
      pageState.showWrongOnly = false; // 搜索模式下关闭错题筛选
      document.getElementById("show-wrong-btn").classList.remove("active");

      // 从当前题库所有题目中搜索包含关键词的题目
      const allQuestions = Object.values(questionData[pageState.currentBank]).flat();
      pageState.searchResults = allQuestions.filter(question => {
        // 检查题目内容、选项、解析中是否包含关键词
        const questionText = (question.question || "").toLowerCase();
        const explanationText = (question.explanation || "").toLowerCase();

        // 检查选项
        let optionsContainKeyword = false;
        if (question.selections) {
          Object.values(question.selections).forEach(option => {
            if (option.toLowerCase().includes(keyword)) {
              optionsContainKeyword = true;
            }
          });
        }

        return questionText.includes(keyword) ||
               optionsContainKeyword ||
               explanationText.includes(keyword);
      });

      // 更新总页数
      pageState.totalPages.search = Math.ceil(pageState.searchResults.length / pageState.pageSize);

      // 更新UI
      document.getElementById("current-type-title").textContent = `搜索结果: "${keyword}"`;
      document.getElementById("shuffle-btn").style.display = "none"; // 搜索模式下隐藏打乱按钮
      document.getElementById("reset-search-btn").style.display = "block"; // 显示重置按钮
      document.getElementById("search-results-info").style.display = "block";
      document.getElementById("search-results-info").textContent =
        `找到 ${pageState.searchResults.length} 个匹配的题目`;

      // 重新渲染
      renderAllNavItems(); // 高亮显示搜索结果中的题目
      renderQuestions();
      renderPagination();
    }

    /**
     * 重置搜索，返回原题模式
     */
    function resetSearch() {
      pageState.searchMode = false;
      pageState.searchResults = [];
      pageState.searchKeyword = "";
      pageState.currentPage = 1;

      // 清空搜索框
      document.getElementById("search-input").value = "";

      // 更新UI
      document.getElementById("current-type-title").textContent =
        Object.keys(TYPE_MAPPING).find(name => TYPE_MAPPING[name] === pageState.currentType);
      document.getElementById("shuffle-btn").style.display = "inline-block"; // 显示打乱按钮
      document.getElementById("reset-search-btn").style.display = "none"; // 隐藏重置按钮
      document.getElementById("search-results-info").style.display = "none";

      // 重新渲染
      renderAllNavItems();
      renderQuestions();
      renderPagination();
    }

    /**
     * 高亮文本中的关键词
     */
    function highlightText(text, keyword) {
      if (!keyword || !text) return text;
      const regex = new RegExp(`(${keyword})`, 'gi');
      return text.replace(regex, '<span class="search-highlight">$1</span>');
    }

    /**
     * 渲染所有题型的导航序号
     */
    function renderAllNavItems() {
      const currentBank = pageState.currentBank;

      Object.keys(TYPE_MAPPING).forEach(typeName => {
        const typeKey = TYPE_MAPPING[typeName];
        const questions = questionData[currentBank][typeKey];
        const navContainer = document.getElementById(`${typeKey}-nav-items`);
        navContainer.innerHTML = "";

        // 如果只显示错题，过滤出当前题型的错题
        let displayQuestions = questions;
        if (pageState.showWrongOnly && !pageState.searchMode) {
          displayQuestions = questions.filter(q => answerStatus[q.uniqueKey] === "incorrect" ||
  favoriteStatus[q.uniqueKey]);
        }

        displayQuestions.forEach((question, index) => {
          const questionId = question.id;
          const uniqueKey = question.uniqueKey;
          const status = answerStatus[uniqueKey];
          // 计算当前题目所属页码
          const page = Math.ceil((index + 1) / pageState.pageSize);

          // 搜索模式下，标记搜索结果中的题目
          const isSearchResult = pageState.searchMode &&
                                pageState.searchResults.some(q => q.uniqueKey === uniqueKey);

          const navItem = document.createElement("div");
          navItem.className = `nav-item ${status} ${
            // 搜索模式下，搜索结果中的题目高亮
            pageState.searchMode ? (isSearchResult ? "active" : "") :
            // 正常模式下，当前题型和页码的题目高亮
            (typeKey === pageState.currentType && page === pageState.currentPage ? "active" : "")
          }`;
          navItem.textContent = questionId; // 显示题目自身ID
          navItem.dataset.uniqueKey = uniqueKey;
          navItem.dataset.type = typeKey;
          navItem.dataset.page = page;
          navItem.dataset.questionId = questionId;

          // 点击序号跳转
          navItem.addEventListener("click", () => {
            // 如果在搜索模式下点击导航，退出搜索模式
            if (pageState.searchMode) {
              resetSearch();
            }

            const targetType = typeKey;
            const targetPage = page;

            // 更新当前状态
            pageState.currentType = targetType;
            pageState.currentPage = targetPage;

            // 更新题型标题
            document.getElementById("current-type-title").textContent = typeName;

            // 重新渲染
            renderAllNavItems();
            renderQuestions();
            renderPagination();

            // 滚动到目标题目
            const targetQuestion = document.getElementById(`question-${uniqueKey}`);
            if (targetQuestion) {
              targetQuestion.scrollIntoView({ behavior: "smooth", block: "start" });
            }
          });

          navContainer.appendChild(navItem);
        });
      });
    }

    /**
     * 渲染当前题型+当前页的题目
     */
    function renderQuestions() {
      const questionList = document.getElementById("question-list");
      questionList.innerHTML = "";

      let displayQuestions = [];
      const currentBank = pageState.currentBank;

      if (pageState.searchMode) {
        // 搜索模式下显示搜索结果
        if (pageState.searchResults.length === 0) {
          questionList.innerHTML = `<div class="error">没有找到与"${pageState.searchKeyword}"相关的题目</div>`;
          return;
        }

        // 计算当前页显示的搜索结果范围
        const startIndex = (pageState.currentPage - 1) * pageState.pageSize;
        const endIndex = Math.min(startIndex + pageState.pageSize, pageState.searchResults.length);
        displayQuestions = pageState.searchResults.slice(startIndex, endIndex);
      } else {
        // 正常模式下显示当前题型的题目
        let currentQuestions = questionData[currentBank][pageState.currentType];

        // 如果只显示错题，进行过滤
        if (pageState.showWrongOnly) {
          currentQuestions = currentQuestions.filter(q => answerStatus[q.uniqueKey] === "incorrect" ||
  favoriteStatus[q.uniqueKey]);
        }

        // 无题目时的提示
        if (currentQuestions.length === 0) {
          const message = pageState.showWrongOnly
            ? "当前题型没有收藏或错题"
            : `暂无${Object.keys(TYPE_MAPPING).find(name => TYPE_MAPPING[name] === pageState.currentType)}题目`;
          questionList.innerHTML = `<div class="error">${message}</div>`;
          return;
        }

        // 计算当前页显示的题目范围
        const startIndex = (pageState.currentPage - 1) * pageState.pageSize;
        const endIndex = Math.min(startIndex + pageState.pageSize, currentQuestions.length);
        displayQuestions = currentQuestions.slice(startIndex, endIndex);
      }

      // 渲染当前页的题目
      displayQuestions.forEach(question => {
        const { uniqueKey, id: questionId, typeKey, question: questionContent, selections } = question;
        const questionEl = document.createElement("div");
        // 搜索模式下使用不同的类名
        questionEl.className = pageState.searchMode
          ? "question-container search-result"
          : "question-container active";
        questionEl.id = `question-${uniqueKey}`;
        questionEl.dataset.uniqueKey = uniqueKey;
        questionEl.dataset.type = typeKey;

        // 生成选项HTML
        const optionsHtml = generateOptionsHtml(question);

        // 处理解析内容
        const explanationContent = getExplanationContent(question);

        // 高亮显示搜索关键词
        const highlightedQuestionContent = pageState.searchMode
          ? highlightText(questionContent, pageState.searchKeyword)
          : questionContent;

        // 构建题目HTML
        questionEl.innerHTML = `
          <div class="question-header">${questionId}. ${highlightedQuestionContent}
              <span
                class="favorite-btn"
                data-key="${uniqueKey}"
                style="float:right;cursor:pointer;font-size:1.2rem;"
              >
                ${favoriteStatus[uniqueKey] ? '⭐' : '☆'}
              </span>
          </div>
          ${optionsHtml}
          <button class="btn-check" data-unique-key="${uniqueKey}">查看解析</button>
          <div class="result" id="result-${uniqueKey}"></div>
          <div class="explanation" id="explanation-${uniqueKey}">${explanationContent}</div>
        `;

        // 已作答的题目：显示结果和解析，保留选中状态
        if (answerStatus[uniqueKey] !== "unanswered" || GET_EXLPAIN) {
          const resultEl = questionEl.querySelector(`#result-${uniqueKey}`);
          const explanationEl = questionEl.querySelector(`#explanation-${uniqueKey}`);
          const isCorrect = answerStatus[uniqueKey] === "correct";

          resultEl.style.display = "block";
          const correctAnswerText = getCorrectAnswerText(question);
          resultEl.textContent = isCorrect
            ? "✅ 回答正确！"
            : `❌ 回答错误！正确答案是：${correctAnswerText}`;
          resultEl.className = `result ${isCorrect ? "correct" : "incorrect"}`;
          explanationEl.style.display = "block";

          // 保留选中状态
          setSelectedAnswers(questionEl, question);
        }

        questionList.appendChild(questionEl);
      });
    }

    /**
     * 生成不同题型的选项HTML
     */
    function generateOptionsHtml(question) {
      const { uniqueKey, typeKey, selections = {} } = question;
      const optionKeys = Object.keys(selections).sort((a, b) => {
        // 按A、B、C、D、E顺序排序
        return a.charCodeAt(0) - b.charCodeAt(0);
      });

      // 无选项时的提示
      if (optionKeys.length === 0 && typeKey !== "judgment") {
        return '<div class="no-options">该题目无选项</div>';
      }

      let optionsHtml = '<div class="option-group">';

      if (typeKey === "judgment") {
        // 判断题：固定正确/错误选项
        optionsHtml += `
          <label class="option">
            <input type="radio" id="opt-${uniqueKey}-Y" name="opt-${uniqueKey}" value="Y">
            <span>正确（Y）</span>
          </label>
          <label class="option">
            <input type="radio" id="opt-${uniqueKey}-N" name="opt-${uniqueKey}" value="N">
            <span>错误（N）</span>
          </label>
        `;
      } else if (typeKey === "single") {
        // 单选题：radio按钮
        optionKeys.forEach(key => {
          let value = selections[key];
          // 搜索模式下高亮选项中的关键词
          if (pageState.searchMode) {
            value = highlightText(value, pageState.searchKeyword);
          }
          optionsHtml += `
            <label class="option">
              <input type="radio" id="opt-${uniqueKey}-${key}" name="opt-${uniqueKey}" value="${key}">
              <span>${key}、${value}</span>
            </label>
          `;
        });
      } else if (typeKey === "multiple") {
        // 多选题：checkbox按钮
        optionKeys.forEach(key => {
          let value = selections[key];
          // 搜索模式下高亮选项中的关键词
          if (pageState.searchMode) {
            value = highlightText(value, pageState.searchKeyword);
          }
          optionsHtml += `
            <label class="option">
              <input type="checkbox" id="opt-${uniqueKey}-${key}" name="opt-${uniqueKey}-${key}" value="${key}">
              <span>${key}、${value}</span>
            </label>
          `;
        });
      }

      optionsHtml += '</div>';
      return optionsHtml;
    }

    function showAllQuestions(){
        GET_EXLPAIN = !GET_EXLPAIN;
        const btn = document.getElementById("toggleExplainBtn");
            if (GET_EXLPAIN) {
            btn.textContent = "关闭背题模式";
            btn.style.backgroundColor = "#f44336";
        } else {
            btn.textContent = "开启背题模式（直接看解析）";
            btn.style.backgroundColor = "#ff9800";
        }
        // 重新渲染
      renderAllNavItems();
      renderQuestions();
      renderPagination();
    }

    /**
     * 处理解析内容
     */
    function getExplanationContent(question) {
      let content = question.explanation && question.explanation.trim()
        ? question.explanation.trim()
        : `正确答案：${getCorrectAnswerText(question)}`;

      // 搜索模式下高亮解析中的关键词
      if (pageState.searchMode) {
        content = highlightText(content, pageState.searchKeyword);
      }

      return content;
    }

    /**
     * 生成易读的正确答案文本
     */
    function getCorrectAnswerText(question) {
      const { typeKey, answer, selections = {} } = question;
      const answerKeys = Array.isArray(answer)
        ? answer
        : answer.split('').filter(key => key); // 过滤空字符

      if (typeKey === "judgment") {
        return answer === "Y" ? "正确（Y）" : "错误（N）";
      } else {
        return answerKeys.map(key => {
          return `${key}`;
        }).join("");
      }
    }

    /**
     * 保留已选中的答案
     */
    function setSelectedAnswers(questionEl, question) {
      const { uniqueKey, typeKey, answer } = question;
      const answerKeys = Array.isArray(answer)
        ? answer
        : answer.split('').filter(key => key);

      if (typeKey === "judgment" || typeKey === "single") {
        // 单选/判断题：选中正确答案
        const correctKey = answerKeys[0];
        const radioInput = questionEl.querySelector(`input[id="opt-${uniqueKey}-${correctKey}"]`);
        if (radioInput) radioInput.checked = true;
      }
    }

    function saveLocalState(){
      //localStorage.setItem("answerStatus", JSON.stringify(answerStatus));
      localStorage.setItem("favoriteStatus", JSON.stringify(favoriteStatus));
    }

    /**
     * 渲染翻页控件
     */
    function renderPagination() {
      const currentPage = pageState.currentPage;
      let totalPages;

      if (pageState.searchMode) {
        totalPages = pageState.totalPages.search || 1;
      } else {
        // 计算当前条件下的总页数
        let currentQuestions = questionData[pageState.currentBank][pageState.currentType];
        if (pageState.showWrongOnly) {
          currentQuestions = currentQuestions.filter(q => answerStatus[q.uniqueKey] === "incorrect" ||
  favoriteStatus[q.uniqueKey]);
        }
        totalPages = Math.ceil(currentQuestions.length / pageState.pageSize) || 1;
      }

      const prevBtn = document.getElementById("prev-page");
      const nextBtn = document.getElementById("next-page");
      const pageInfo = document.getElementById("page-info");

      // 更新按钮状态
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages;

      // 更新页码信息
      pageInfo.textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页`;
    }

    /**
     * 检查答案并更新状态
     */
    function checkAnswer(uniqueKey) {
      // 找到对应的题目
      const question = Object.values(questionData).flatMap(bank =>
        Object.values(bank).flat()
      ).find(q => q.uniqueKey === uniqueKey);

      if (!question) return;

      const { typeKey, answer } = question;
      const questionEl = document.getElementById(`question-${uniqueKey}`);
      const resultEl = document.getElementById(`result-${uniqueKey}`);
      const explanationEl = document.getElementById(`explanation-${uniqueKey}`);

      // 获取用户选择的答案
      let userAnswer = [];
      if (typeKey === "judgment" || typeKey === "single") {
        // 单选/判断题
        const selectedInput = questionEl.querySelector(`input[name="opt-${uniqueKey}"]:checked`);
        if (selectedInput) {
          userAnswer = [selectedInput.value];
        }
      } else if (typeKey === "multiple") {
        // 多选题
        const selectedInputs = questionEl.querySelectorAll(`input[id^="opt-${uniqueKey}-"]:checked`);
        userAnswer = Array.from(selectedInputs).map(input => input.value);
      }

      // 处理正确答案格式
      const correctAnswer = Array.isArray(answer) ? answer : answer.split('').filter(key => key);

      // 判断是否正确（排序后比较，避免顺序问题）
      const isCorrect = JSON.stringify(userAnswer.sort()) === JSON.stringify(correctAnswer.sort());

      // 更新作答状态
      answerStatus[uniqueKey] = isCorrect ? "correct" : "incorrect";

      // 显示结果和解析
      resultEl.style.display = "block";
      const correctAnswerText = getCorrectAnswerText(question);
      resultEl.textContent = isCorrect
        ? "✅ 回答正确！"
        : `❌ 回答错误！正确答案是：${correctAnswerText}`;
      resultEl.className = `result ${isCorrect ? "correct" : "incorrect"}`;
      explanationEl.style.display = "block";

      // 更新导航栏状态
      renderAllNavItems();

      // 如果处于只显示错题模式，且当前题目变为正确，重新渲染
      if (pageState.showWrongOnly && isCorrect) {
        renderQuestions();
        renderPagination();
      }
    }

    /**
     * 滚动到页面顶部
     */
    function scrollToTop() {
      const questionList = document.getElementById("question-list");
      if (questionList) {
        const top = questionList.getBoundingClientRect().top + window.pageYOffset - 20;
        window.scrollTo({
          top: top,
          behavior: "smooth"
        });
      }
    }
  </script>
</body>
</html>